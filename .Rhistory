carba_cols <- c('ipm_nd10_ris','ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris',
'etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
carba_cols_check <- colnames(pan_s_result[,intersect(carba_cols, colnames(pan_s_result))])
ris_result <- subset(pan_s_result, select = carba_cols_check)
ris_result <- ris_result[,colSums(is.na(ris_result))<nrow(ris_result)]
#combine demogs and ris result columns
pan_s_result <- cbind(demogs, ris_result)
#edit format
pan_s_result$referral_date <- format(as.Date(pan_s_result$referral_date), "%Y-%m-%d")
pan_s_result$spec_date <- format(as.Date(pan_s_result$spec_date), "%Y-%m-%d")
pan_s_result$accession_no <- sub("_", "-", pan_s_result$accession_no)
if (org_code == "kpn_neo"){
pan_s_result$organismcode[pan_s_result$organismcode == 'kpn'] <- 'kpn_neo'
}
if (nrow(pan_s_result)!=0){
unusual_filename <- paste("Excel/table/",org_code,"_pan_s_result3.csv", sep="")
#write.csv(pan_s_result, file=unusual_filename, row.names = FALSE)
# Use parse_date_time to handle multiple formats in a vectorized way
pan_s_result$referral_date <- parse_date_time(pan_s_result$referral_date, orders = "ymd")
pan_s_result$spec_date <- parse_date_time(pan_s_result$spec_date, orders = "ymd")
pan_s_result$referral_date <- as.character(pan_s_result$referral_date)
pan_s_result$spec_date <- as.character(pan_s_result$spec_date)
final_unusual_result <- subset(pan_s_result, select = c('accession_no','referral_date','spec_date','organismcode','RIS'))
#binds rows of 2 input data frames
referred_df <<- rbind(referred_df,final_unusual_result)
return(data.frame(pan_s_result))
}
}
}
kpn_pan_s_result <- pan_s(df_kpn,'kpn','ebc')
kpn_neo_pan_s_result <- pan_s(df_kpn_neo,'kpn_neo','ebc')
#sort the unusual_result in increasing order based on Accession number
referred_df <- referred_df[order(referred_df$organismcode,decreasing = FALSE), ]
writexl::write_xlsx(referred_df,  path =paste0("Excel/table/",AccessionNo,"_summary_unusual_result.xlsx"))
#ac_list <- df_monitoring$ACCESSION_NO
#df_reference <- df %>% filter(accession_no %in% ac_list)
#df_reference_diff <- df %>% filter(!accession_no %in% ac_list)
#ac_list_ref <- df$accession_no
#ac_diff <- setdiff(ac_list, ac_list_ref)
#df_monitoring_remove <- df_monitoring %>% filter(ACCESSION_NO %in% ac_diff)
#unusual_filename <- paste("Excel/", AccessionNo, "_unusual_result.csv", sep="")
#write.csv(df_final, file="Excel/referred_unusual_result.csv", row.names = FALSE)
#reading data file
df <- read_excel("Excel/Combined Data on Referred Isolates_3.14.25.xlsx", "ARSRL")
AccessionNo <- dlgInput("Enter a site code:", Sys.info()[" "])$res
# Transform column names to upper case
colnames(df) <- tolower(colnames(df))
names(df)[names(df) == 'accessionno'] <- 'accession_no'
colnames(df) <- gsub(' ', '_', colnames(df))
#filter dataframe based on site code
site_df <- df %>%
filter(grepl(AccessionNo, accession_no))
#lOad updated monitoring
#df_monitoring <- read_excel("Excel/Referred Isolates Monitoring 2024 (ARSRL RESULT)  as of March 07, 2025.xlsx", "all")
#df_monitoring <-  df_monitoring %>% remove_empty(c("rows"))
#site_df_data <- df_monitoring %>%
#  filter(grepl(AccessionNo, ACCESSION_NO))
#list all existing accession number
#existing_ac <- site_df_data$ACCESSION_NO
#existing_ac <- gsub('-', '_', existing_ac)
#remove accession number in the monitoring form
#site_df <- site_df[!site_df$accession_no %in% existing_ac, ]
site_df$spec_date <- format(as.Date(site_df$spec_date), "%Y-%m-%d")
kpn_valid_specdate <- c("2024-09","2024-10","2024-11","2024-12","2025-01", "2025-02", "2025-03")
site_df <- filter(site_df, str_detect(spec_date, paste(kpn_valid_specdate, collapse="|")))
#write.csv(site_df, file=paste("Excel/","df_",AccessionNo,".csv",sep = ""))
#setwd("D:/ALLYSA FILE/2024/DMU Projects/referable-isolates")
org_dataframe <- function(df,org){
#List all organism based on organism group
org_path <- "Excel/ORG GROUPINGS_09042024.xlsx"
df_org <- read_excel(org_path, org)
org_vec <- na.omit(df_org[['ORG']])
org_df <- df[df$organismcode %in% org_vec, ]
#List sterile and non-sterile samples
sample_path <- "Excel/SPCLIST_2024referrables_08292024.xlsx"
ss_df <- read_excel(sample_path, org)
ss_vec <- na.omit(ss_df[['C_ENGLISH']])
#Generate dataframe for referral regardless of date
org_df <- org_df[org_df$spec_type %in% ss_vec, ]
#filter dataframe based on urine count
org_df$urine_colct <- as.numeric(gsub("\\D", "", org_df$urine_colct ))
org_df <- subset(org_df, org_df$urine_colct  > 10000 | is.na(org_df$urine_colct ))
#org_filename <- paste("Excel/table/","df_",org,".csv",sep = "")
#write.csv(org_df, file=org_filename)
return(data.frame(org_df))
}
df_kpn <- org_dataframe(site_df,'kpn')
df_kpn_neo <- org_dataframe(site_df,'kpn_neo')
neo_age <- c("0", "1d", "2d", "3d", "4d", "5d", "6d", "7d", "8d", "9d", "10d", "11d", "12d", "13d", "14d"
, "15d", "16d", "17d", "18d", "19d", "20d", "21d", "22d", "23d", "24d", "25d", "26d", "27d", "28d")
df_kpn_neo <- df_kpn_neo[df_kpn_neo$age %in% neo_age, ]
#create empty dataframe for summary
referred_df <- data.frame(accession_no = character(),
referral_date = character(),
spec_date = character(),
organismcode = character(),
RIS = character(),
stringsAsFactors = FALSE)
#Selecting antibitics based on referral date and RIS result
referral_selector <- function(df,sheet_name,ref_days,ris_result){
antibiotic_path <- "Excel/whonet_data_summary_referred_updated.xlsx"
rs_df <- read_excel(antibiotic_path, sheet_name)
rs_df <- rs_df[rs_df$REF_DAYS == ref_days & rs_df$RIS == ris_result, ]
rs_vec <- rs_df[['WHON5_CODE_LW']]
rs_vec <- paste(rs_vec,'ris', sep = '_')
#list existing columns only in the dataframe included in the antibiotic list
rs_vec <- intersect(rs_vec, colnames(df))
#return(data.frame(rs_df))
return(list(data.frame(rs_df), rs_vec = rs_vec))
}
pan_s_selector <- function(df,sheet_name){
antibiotic_path <- "Excel/CLSI_ORG_ATC_updated.xlsx"
rs_df <- read_excel(antibiotic_path, sheet_name)
rs_vec <- c(rs_df[['WHON5_CODE_DISK']], rs_df[['WHON5_CODE_MIC']], rs_df[['WHON5_CODE_ETEST']])
#list existing columns only in the dataframe included in the antibiotic list
rs_vec <- intersect(rs_vec, colnames(df))
#return(data.frame(rs_df))
return(list(data.frame(rs_df), rs_vec = rs_vec))
}
#Pan susceptible
referred_pan_s <- function(df,antibiotics){
if(length(antibiotics) !=0){
#Check if columns in columns_to_check have all NA values
cols_to_remove <- sapply(antibiotics, function(col) {
all(is.na(df[[col]]))
})
# Create a vector of column names to keep
at_to_keep <- antibiotics[!cols_to_remove]
df <- df %>%
#filter(if_all(at_to_keep, ~ grepl("S", .)))
filter(if_all(at_to_keep, ~ !grepl("R|NS|SDD|I", .)))
return(data.frame(df))
}
}
referred_pan_r <- function(df,antibiotics){
if(length(antibiotics) !=0){
#Check if columns in columns_to_check have all NA values
cols_to_remove <- sapply(antibiotics, function(col) {
all(is.na(df[[col]]))
})
# Create a vector of column names to keep
at_to_keep <- antibiotics[!cols_to_remove]
df <- df %>%
filter(if_all(at_to_keep, ~ !grepl("S|NS|SDD|I", .)))
return(data.frame(df))
}
}
#Resistant
referred_ris1 <- function(df,ris_1,antibiotics){
if(length(antibiotics) !=0){
df <- df %>%
filter(if_any(antibiotics, ~ .x == ris_1))
return(data.frame(df))
}
}
unusual_result <- function(df, org_code){
at_cols <- c('ipm_nd10_ris','ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris',
'etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
unusual_result <- if (nrow(df != 0)){referred_pan_r(df,at_cols)}
if ((nrow(unusual_result) != 0) && !is.null(unusual_result)){
unusual_result$ref_days <- if ((nrow(unusual_result) != 0) && !is.null(unusual_result)) {"first"}
unusual_result$RIS <- if ((nrow(unusual_result) != 0) && !is.null(unusual_result)) {"R"}
#keeps demogs column
demogs <- subset(unusual_result, select = c('accession_no','referral_date','spec_date','organismcode',
'RIS','spec_type','growth','esbl', 'ref_days'))
#select ris columns and remove columns will ALL NA values
at_cols <- grep("_ris", names(unusual_result), value = TRUE)
ris_result <- subset(unusual_result, select = at_cols)
ris_result <- ris_result[,colSums(is.na(ris_result))<nrow(ris_result)]
carba_cols <- c('ipm_nd10_ris','ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris',
'etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
carba_cols_check <- colnames(unusual_result[,intersect(carba_cols, colnames(unusual_result))])
ris_result <- subset(unusual_result, select = carba_cols_check)
ris_result <- ris_result[,colSums(is.na(ris_result))<nrow(ris_result)]
#combine demogs and ris result columns
unusual_result <- cbind(demogs, ris_result)
#edit format
unusual_result$referral_date <- format(as.Date(unusual_result$referral_date), "%Y-%m-%d")
unusual_result$spec_date <- format(as.Date(unusual_result$spec_date), "%Y-%m-%d")
unusual_result$accession_no <- sub("_", "-", unusual_result$accession_no)
duplicates <- unusual_result$accession_no[duplicated(unusual_result$accession_no)]
if (length(duplicates) !=0){
unusual_result <- unusual_result %>% distinct(accession_no, .keep_all = TRUE)
}
#sort the unusual_result in increasing order based on Accession number
unusual_result <- unusual_result[order(unusual_result$accession_no,decreasing = FALSE), ]
if (org_code == "kpn_neo"){
unusual_result$organismcode[unusual_result$organismcode == 'kpn'] <- 'kpn_neo'
}
if (nrow(unusual_result)!=0){
unusual_filename <- paste("Excel/table/",org_code,"_unusual_list3.csv", sep="")
#write.csv(unusual_result, file=unusual_filename, row.names = FALSE)
# Use parse_date_time to handle multiple formats in a vectorized way
unusual_result$referral_date <- parse_date_time(unusual_result$referral_date, orders = "ymd")
unusual_result$spec_date <- parse_date_time(unusual_result$spec_date, orders = "ymd")
unusual_result$referral_date <- as.character(unusual_result$referral_date)
unusual_result$spec_date <- as.character(unusual_result$spec_date)
final_unusual_result <- subset(unusual_result, select = c('accession_no','referral_date','spec_date','organismcode','RIS'))
#binds rows of 2 input data frames
referred_df <<- rbind(referred_df,final_unusual_result)
}
}
return(data.frame(unusual_result))
}
kpn_unusual_result <- unusual_result(df_kpn,'kpn')
kpn_neo_unusual_result <- unusual_result(df_kpn_neo,'kpn_neo')
pan_s <- function(df, org_code, org_group){
at_cols <- c('ipm_nd10_ris','ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris',
'etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
pan_s_result <- if (nrow(df != 0)){referred_pan_s(df,at_cols)}
if ((nrow(pan_s_result) != 0)&& !is.null(pan_s_result)){
#add new column to separate referral days and set RIS value to "S"
pan_s_result$ref_days <- "pan"
pan_s_result$RIS <- "S"
#keeps demogs column
demogs <- subset(pan_s_result, select = c('accession_no','referral_date','spec_date','organismcode',
'RIS','spec_type','growth','esbl', 'ref_days'))
#select ris columns and remove columns will ALL NA values
carba_cols <- c('ipm_nd10_ris','ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris',
'etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
carba_cols_check <- colnames(pan_s_result[,intersect(carba_cols, colnames(pan_s_result))])
ris_result <- subset(pan_s_result, select = carba_cols_check)
ris_result <- ris_result[,colSums(is.na(ris_result))<nrow(ris_result)]
#combine demogs and ris result columns
pan_s_result <- cbind(demogs, ris_result)
#edit format
pan_s_result$referral_date <- format(as.Date(pan_s_result$referral_date), "%Y-%m-%d")
pan_s_result$spec_date <- format(as.Date(pan_s_result$spec_date), "%Y-%m-%d")
pan_s_result$accession_no <- sub("_", "-", pan_s_result$accession_no)
if (org_code == "kpn_neo"){
pan_s_result$organismcode[pan_s_result$organismcode == 'kpn'] <- 'kpn_neo'
}
if (nrow(pan_s_result)!=0){
unusual_filename <- paste("Excel/table/",org_code,"_pan_s_result3.csv", sep="")
#write.csv(pan_s_result, file=unusual_filename, row.names = FALSE)
# Use parse_date_time to handle multiple formats in a vectorized way
pan_s_result$referral_date <- parse_date_time(pan_s_result$referral_date, orders = "ymd")
pan_s_result$spec_date <- parse_date_time(pan_s_result$spec_date, orders = "ymd")
pan_s_result$referral_date <- as.character(pan_s_result$referral_date)
pan_s_result$spec_date <- as.character(pan_s_result$spec_date)
final_unusual_result <- subset(pan_s_result, select = c('accession_no','referral_date','spec_date','organismcode','RIS'))
#binds rows of 2 input data frames
referred_df <<- rbind(referred_df,final_unusual_result)
return(data.frame(pan_s_result))
}
}
}
kpn_pan_s_result <- pan_s(df_kpn,'kpn','ebc')
kpn_neo_pan_s_result <- pan_s(df_kpn_neo,'kpn_neo','ebc')
#sort the unusual_result in increasing order based on Accession number
referred_df <- referred_df[order(referred_df$organismcode,decreasing = FALSE), ]
writexl::write_xlsx(referred_df,  path =paste0("Excel/table/",AccessionNo,"_summary_unusual_result.xlsx"))
#ac_list <- df_monitoring$ACCESSION_NO
#df_reference <- df %>% filter(accession_no %in% ac_list)
#df_reference_diff <- df %>% filter(!accession_no %in% ac_list)
#ac_list_ref <- df$accession_no
#ac_diff <- setdiff(ac_list, ac_list_ref)
#df_monitoring_remove <- df_monitoring %>% filter(ACCESSION_NO %in% ac_diff)
#unusual_filename <- paste("Excel/", AccessionNo, "_unusual_result.csv", sep="")
#write.csv(df_final, file="Excel/referred_unusual_result.csv", row.names = FALSE)
View(df_kpn)
View(kpn_unusual_result)
#reading data file
df <- read_excel("Excel/Combined Data on Referred Isolates_3.14.25.xlsx", "ARSRL")
AccessionNo <- dlgInput("Enter a site code:", Sys.info()[" "])$res
# Transform column names to upper case
colnames(df) <- tolower(colnames(df))
names(df)[names(df) == 'accessionno'] <- 'accession_no'
colnames(df) <- gsub(' ', '_', colnames(df))
#filter dataframe based on site code
site_df <- df %>%
filter(grepl(AccessionNo, accession_no))
#lOad updated monitoring
#df_monitoring <- read_excel("Excel/Referred Isolates Monitoring 2024 (ARSRL RESULT)  as of March 07, 2025.xlsx", "all")
#df_monitoring <-  df_monitoring %>% remove_empty(c("rows"))
#site_df_data <- df_monitoring %>%
#  filter(grepl(AccessionNo, ACCESSION_NO))
#list all existing accession number
#existing_ac <- site_df_data$ACCESSION_NO
#existing_ac <- gsub('-', '_', existing_ac)
#remove accession number in the monitoring form
#site_df <- site_df[!site_df$accession_no %in% existing_ac, ]
site_df$spec_date <- format(as.Date(site_df$spec_date), "%Y-%m-%d")
kpn_valid_specdate <- c("2024-09","2024-10","2024-11","2024-12","2025-01", "2025-02", "2025-03")
site_df <- filter(site_df, str_detect(spec_date, paste(kpn_valid_specdate, collapse="|")))
#write.csv(site_df, file=paste("Excel/","df_",AccessionNo,".csv",sep = ""))
#setwd("D:/ALLYSA FILE/2024/DMU Projects/referable-isolates")
org_dataframe <- function(df,org){
#List all organism based on organism group
org_path <- "Excel/ORG GROUPINGS_09042024.xlsx"
df_org <- read_excel(org_path, org)
org_vec <- na.omit(df_org[['ORG']])
org_df <- df[df$organismcode %in% org_vec, ]
#List sterile and non-sterile samples
sample_path <- "Excel/SPCLIST_2024referrables_08292024.xlsx"
ss_df <- read_excel(sample_path, org)
ss_vec <- na.omit(ss_df[['C_ENGLISH']])
#Generate dataframe for referral regardless of date
org_df <- org_df[org_df$spec_type %in% ss_vec, ]
cols_to_retain <- c('accession_no','referral_date','spec_date','organismcode','spec_type','growth','ipm_nd10_ris',
'ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris','etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
org_df <- subset(org_df, select = c(cols_to_retain))
#org_filename <- paste("Excel/table/","df_",org,".csv",sep = "")
#write.csv(org_df, file=org_filename)
return(data.frame(org_df))
}
df_kpn <- org_dataframe(site_df,'kpn')
org_dataframe <- function(df,org){
#List all organism based on organism group
org_path <- "Excel/ORG GROUPINGS_09042024.xlsx"
df_org <- read_excel(org_path, org)
org_vec <- na.omit(df_org[['ORG']])
org_df <- df[df$organismcode %in% org_vec, ]
#List sterile and non-sterile samples
sample_path <- "Excel/SPCLIST_2024referrables_08292024.xlsx"
ss_df <- read_excel(sample_path, org)
ss_vec <- na.omit(ss_df[['C_ENGLISH']])
#Generate dataframe for referral regardless of date
org_df <- org_df[org_df$spec_type %in% ss_vec, ]
cols_to_retain <- c('accession_no','referral_date','spec_date','organismcode','spec_type','growth','ipm_nd10_ris',
'ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris','etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
cols_check <- colnames(org_df[,intersect(cols_to_retain, colnames(org_df))])
org_df <- subset(org_df, select = c(cols_check))
#org_filename <- paste("Excel/table/","df_",org,".csv",sep = "")
#write.csv(org_df, file=org_filename)
return(data.frame(org_df))
}
df_kpn <- org_dataframe(site_df,'kpn')
View(df_kpn)
org_dataframe <- function(df,org){
#List all organism based on organism group
org_path <- "Excel/ORG GROUPINGS_09042024.xlsx"
df_org <- read_excel(org_path, org)
org_vec <- na.omit(df_org[['ORG']])
org_df <- df[df$organismcode %in% org_vec, ]
#List sterile and non-sterile samples
sample_path <- "Excel/SPCLIST_2024referrables_08292024.xlsx"
ss_df <- read_excel(sample_path, org)
ss_vec <- na.omit(ss_df[['C_ENGLISH']])
#Generate dataframe for referral regardless of date
org_df <- org_df[org_df$spec_type %in% ss_vec, ]
cols_to_retain <- c('accession_no','referral_date','spec_date','organismcode','spec_type','growth','ipm_nd10_ris',
'ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris','etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
cols_check <- colnames(org_df[,intersect(cols_to_retain, colnames(org_df))])
org_df <- subset(org_df, select = c(cols_check))
#Check if columns in columns_to_check have all NA values
cols_to_remove <- sapply(cols_to_retain, function(col) {
all(is.na(org_df[[col]]))
})
org_df <- subset(org_df, select = -c(cols_to_remove))
#org_filename <- paste("Excel/table/","df_",org,".csv",sep = "")
#write.csv(org_df, file=org_filename)
return(data.frame(org_df))
}
df_kpn <- org_dataframe(site_df,'kpn')
View(df_kpn)
View(df_kpn)
View(site_df)
org_dataframe <- function(df,org){
#List all organism based on organism group
org_path <- "Excel/ORG GROUPINGS_09042024.xlsx"
df_org <- read_excel(org_path, org)
org_vec <- na.omit(df_org[['ORG']])
org_df <- df[df$organismcode %in% org_vec, ]
#List sterile and non-sterile samples
sample_path <- "Excel/SPCLIST_2024referrables_08292024.xlsx"
ss_df <- read_excel(sample_path, org)
ss_vec <- na.omit(ss_df[['C_ENGLISH']])
#Generate dataframe for referral regardless of date
org_df <- org_df[org_df$spec_type %in% ss_vec, ]
cols_to_retain <- c('accession_no','referral_date','spec_date','organismcode','spec_type','growth','ipm_nd10_ris',
'ipm_nm_ris','ipm_ne_ris','mem_nd10_ris','mem_nm_ris','mem_ne_ris','etp_nd10_ris','etp_nm_ris','etp_ne_ris' )
cols_check <- colnames(org_df[,intersect(cols_to_retain, colnames(org_df))])
org_df <- subset(org_df, select = c(cols_check))
# Remove columns where all values are NA
org_df <- org_df[, colSums(is.na(org_df)) < nrow(org_df)]
#org_filename <- paste("Excel/table/","df_",org,".csv",sep = "")
#write.csv(org_df, file=org_filename)
return(data.frame(org_df))
}
df_kpn <- org_dataframe(site_df,'kpn')
View(df_kpn)
df_kpn_neo <- org_dataframe(site_df,'kpn_neo')
neo_age <- c("0", "1d", "2d", "3d", "4d", "5d", "6d", "7d", "8d", "9d", "10d", "11d", "12d", "13d", "14d"
, "15d", "16d", "17d", "18d", "19d", "20d", "21d", "22d", "23d", "24d", "25d", "26d", "27d", "28d")
df_kpn_neo <- df_kpn_neo[df_kpn_neo$age %in% neo_age, ]
#create empty dataframe for summary
referred_df <- data.frame(accession_no = character(),
referral_date = character(),
spec_date = character(),
organismcode = character(),
RIS = character(),
stringsAsFactors = FALSE)
if ((nrow(df_kpn) != 0) && !is.null(df_kpn)){
abx_cols <- colnames(df_kpn)[grepl("_ris", colnames(df_kpn))]
}
if ((nrow(df_kpn) != 0) && !is.null(df_kpn)){
abx_cols <- colnames(df_kpn)[grepl("_ris", colnames(df_kpn))]
df_filtered <- df %>% filter(if_any(c(abx_cols), ~ . == "R"))
}
if ((nrow(df_kpn) != 0) && !is.null(df_kpn)){
abx_cols <- colnames(df_kpn)[grepl("_ris", colnames(df_kpn))]
df_filtered <- df_kpn %>% filter(if_any(c(abx_cols), ~ . == "R"))
}
View(df_filtered)
if ((nrow(df_kpn) != 0) && !is.null(df_kpn)){
abx_cols <- colnames(df_kpn)[grepl("_ris", colnames(df_kpn))]
df_filtered <- df_kpn %>% filter(if_all(c(abx_cols), ~ . == "R"))
}
View(df_filtered)
if ((nrow(df_kpn_neo) != 0) && !is.null(df_kpn_neo)){
abx_cols <- colnames(df_kpn_neo)[grepl("_ris", colnames(df_kpn_neo))]
kpn_neo_r <- df_kpn_neo %>% filter(if_all(c(abx_cols), ~ . == "R"))
}
unusual_result <- function(df, RIS){
if ((nrow(df) != 0) && !is.null(df)){
abx_cols <- colnames(df)[grepl("_ris", colnames(df))]
df <- df %>% filter(if_all(c(abx_cols), ~ . == RIS))
#edit format
df$accession_no <- sub("_", "-", df$accession_no)
df$referral_date <- parse_date_time(df$referral_date, orders = "ymd")
df$spec_date <- parse_date_time(df$spec_date, orders = "ymd")
df$referral_date <- as.character(df$referral_date)
df$spec_date <- as.character(df$spec_date)
final_unusual_result <- subset(df, select = c('accession_no','referral_date','spec_date','organismcode','RIS'))
#binds rows of 2 input data frames
referred_df <<- rbind(referred_df,final_unusual_result)
}
return(data.frame(df))
}
kpn_r <- unusual_result(df_kpn,'R')
kpn_r <- unusual_result(df_kpn,'R')
unusual_result <- function(df, RIS){
if ((nrow(df) != 0) && !is.null(df)){
abx_cols <- colnames(df)[grepl("_ris", colnames(df))]
df <- df %>% filter(if_all(c(abx_cols), ~ . == RIS))
return(data.frame(df))
}
kpn_r <- unusual_result(df_kpn,'R')
unusual_result <- function(df, RIS){
if ((nrow(df) != 0) && !is.null(df)){
abx_cols <- colnames(df)[grepl("_ris", colnames(df))]
df <- df %>% filter(if_all(c(abx_cols), ~ . == RIS))
return(data.frame(df))
}
}
kpn_r <- unusual_result(df_kpn,'R')
gc()
setwd("D:/ALLYSA FILES/DMU Projects/whonet_data_cleaning")
site_code <- 'BGH'
#load data
df <- read.csv(paste0("site_df/",site_code ,"_raw_df.csv"))
#change column names case to upper
names(df) <- toupper(names(df))
df$INSTITUT <- toupper(df$INSTITUT)
# Convert mixed formats to YYYY-MM-DD
# Define the possible date formats
date_formats <- c(
"ymd HMS",  # YYYY-MM-DD HH:MM:SS
"mdy HM",   # MM/DD/YYYY HH:MM
"mdy"       # MM/DD/YYYY
)
# Use parse_date_time to handle multiple formats in a vectorized way
df$DATE_BIRTH <- parse_date_time(df$DATE_BIRTH, orders = date_formats)
df$DATE_DATA <- parse_date_time(df$DATE_DATA, orders = date_formats)
df$DATE_ADMIS <- parse_date_time(df$DATE_ADMIS, orders = date_formats)
df$SPEC_DATE <- parse_date_time(df$SPEC_DATE, orders = date_formats)
#convert date/time to character
df$DATE_BIRTH <- as.character(df$DATE_BIRTH)
df$DATE_DATA <- as.character(df$DATE_DATA)
df$DATE_ADMIS <- as.character(df$DATE_ADMIS)
df$SPEC_DATE <- as.character(df$SPEC_DATE)
#set x_referred value to blank for regular data
df$X_REFERRED <- ''
#remove NAN values
df[df == 'nan'] <- ''
df[df == 'NaN'] <- ''
df[df == 'NaT'] <- ''
df[is.na(df)] <- ''
df_clean <- df
setwd("D:/ALLYSA FILES/DMU Projects/whonet_data_cleaning")
site_code <- 'BGH'
#load data
df <- read.csv(paste0("site_df/",site_code ,"_raw_df.csv"))
#change column names case to upper
names(df) <- toupper(names(df))
df$INSTITUT <- toupper(df$INSTITUT)
# Convert mixed formats to YYYY-MM-DD
# Define the possible date formats
date_formats <- c(
"ymd HMS",  # YYYY-MM-DD HH:MM:SS
"mdy HM",   # MM/DD/YYYY HH:MM
"mdy"       # MM/DD/YYYY
)
# Use parse_date_time to handle multiple formats in a vectorized way
df$DATE_BIRTH <- parse_date_time(df$DATE_BIRTH, orders = date_formats)
df$DATE_DATA <- parse_date_time(df$DATE_DATA, orders = date_formats)
df$DATE_ADMIS <- parse_date_time(df$DATE_ADMIS, orders = date_formats)
df$SPEC_DATE <- parse_date_time(df$SPEC_DATE, orders = date_formats)
#convert date/time to character
df$DATE_BIRTH <- as.character(df$DATE_BIRTH)
df$DATE_DATA <- as.character(df$DATE_DATA)
df$DATE_ADMIS <- as.character(df$DATE_ADMIS)
df$SPEC_DATE <- as.character(df$SPEC_DATE)
#set x_referred value to blank for regular data
df$X_REFERRED <- ''
#remove NAN values
df[df == 'nan'] <- ''
df[df == 'NaN'] <- ''
df[df == 'NaT'] <- ''
df[is.na(df)] <- ''
df_clean <- df
